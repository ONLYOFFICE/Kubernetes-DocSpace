apiVersion: batch/v1
kind: Job
metadata:
  name: appserver-update
spec:
  backoffLimit: 2
  template:
    spec:
      containers:
      - name: appserver-update
        image: mysql
        env:
        - name: MYSQL_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mysql-password
              key: mysql-root-password
        volumeMounts:
        - name: files-data
          mountPath: /var/www/products/ASC.Files/server/
        - name: people-data
          mountPath: /var/www/products/ASC.People/server/
        - name: crm-data
          mountPath: /var/www/products/ASC.CRM/server/
        - name: project-data
          mountPath: /var/www/products/ASC.Projects/server/
        - name: calendar-data
          mountPath: /var/www/products/ASC.Calendar/server/
        - name: mail-data
          mountPath: /var/www/products/ASC.Mail/server/
#        - name: change-db-scripts
#          mountPath: /sql/changedb.sql
#          subPath: changedb.sql
        - name: update-scripts
          mountPath: /sql/update.sh
          subPath: update.sh
        command: ["/bin/sh", "-c"]
        args: ["/sql/update.sh"]
      volumes:
      - name: files-data
        persistentVolumeClaim:
          claimName: files-data
      - name: people-data
        persistentVolumeClaim:
          claimName: people-data
      - name: crm-data
        persistentVolumeClaim:
          claimName: crm-data
      - name: project-data
        persistentVolumeClaim:
          claimName: project-data
      - name: calendar-data
        persistentVolumeClaim:
          claimName: calendar-data
      - name: mail-data
        persistentVolumeClaim:
          claimName: mail-data
#      - name: change-db-scripts
#        configMap:
#          name: change-db-scripts
      - name: update-scripts
        configMap:
          name: update-appserver
          defaultMode: 0755
      restartPolicy: Never
